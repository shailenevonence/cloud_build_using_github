steps:
  - name: 'gcr.io/cloud-builders/git'
    args: ['clone', 'https://github.com/shailenevonence/cloud_build_using_github.git', '/workspace/repo']
  - name: 'ubuntu'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        rm /workspace/repo/cloudbuild.yaml
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
        if [ "$BRANCH_NAME" == "evonence" ]; then
          echo "Hello World ! Evonence" > /workspace/repo/app.py
        elif [ "$BRANCH_NAME" == "master" ]; then
          echo "Hello World ! Master" > /workspace/repo/app.py
        elif [ "$BRANCH_NAME" == "ncorium" ]; then
          echo "Hello World ! Ncorium" > /workspace/repo/app.py
        else
          echo "Hello World ! Unknown Branch" > /workspace/repo/app.py
        fi
        gcloud builds submit --tag gcr.io/$PROJECT_ID/my-app /workspace/repo
  - name: 'google/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud components install docker-credential-gcr docker
  - name: 'google/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud auth configure-docker
  - name: 'google/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud docker -- pull gcr.io/$PROJECT_ID/my-app
  - name: 'google/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud docker -- tag gcr.io/$PROJECT_ID/my-app gcr.io/$PROJECT_ID/my-app:latest
  - name: 'google/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud docker -- push gcr.io/$PROJECT_ID/my-app:latest
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'compute'
      - 'instances'
      - 'add-metadata'
      - 'git-gcp-vm'
      - '--metadata=startup-script=apt update && apt install -y curl && apt-get install -y lsb-release && echo "deb http://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list && curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add - && apt-get update && apt-get install -y google-cloud-sdk'
      - '--zone=us-central1-a'
      - '--project=$PROJECT_ID'
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - 'compute'
      - 'ssh'
      - 'git-gcp-vm'
      - '--zone=us-central1-a'
      - '--project=$PROJECT_ID'
      - '--command=docker run -d -p 5000:5000 gcr.io/$PROJECT_ID/my-app'
logsBucket: onramp-sample-bucket
